!function(){"use strict";let t=window.RHU;if(null==t)throw new Error("No RHU found. Did you import RHU before running?");t.module({module:"rhu-x/directory",hard:["RHU.WeakCollection","RHU.eventTarget","RHU.CustomEvent"],trace:new Error},(function(){let e=Map.prototype.set,i=Map.prototype.get,o=Map.prototype.delete,r=Set.prototype.clear,s=Set.prototype.add,n=Set.prototype.delete,c=Symbol("DirectoryRecord directory"),h=Symbol("DirectoryRecord key"),l=Symbol("DirectoryRecord update"),u=Symbol("Directory Item"),d=Symbol("Directory Subscribe"),a=Symbol("SubDirectory Add"),p=Symbol("SubDirectory Delete"),y=Symbol("SubDirectory Filter"),f=t.DirectoryRecord=function(e,i,o){t.eventTarget(this),this[c]=e,this[h]=i,this[l](o)};t.definePublicAccessors(f.prototype,{item:{get:function(){return this[u]}},directory:{get:function(){return this[c]}}}),f.prototype[l]=function(e){this.lastUpdated=Date.now(),this[u]=e,this.dispatchEvent(t.CustomEvent("update",this.item))},f.prototype.update=function(t){this.directory.set(this[h],t)},f.prototype.delete=function(){this.dispatchEvent(t.CustomEvent("delete",this.item)),this[u]=null};let b=t.SubDirectory=t.reflectConstruct(Set,"RHU.SubDirectory",(function(e,i=undefined){t.eventTarget(this),e[d](this),this.filter=i}));t.definePublicAccessors(b.prototype,{filter:{get:function(){return this[y]},set:function(t){this[y]=t,this.fetch()}},directory:{get:function(){return m.get(this)}}}),b.prototype.add=function(){throw new Error("You cannot call add() on a subDirectory.")},b.prototype.delete=function(){throw new Error("You cannot call delete() on a subDirectory.")},b.prototype.clear=function(){throw new Error("You cannot call clear() on a subDirectory.")},b.prototype.fetch=function(){if(!t.exists(this.directory))throw new Error("Cannot fetch whilst unsubscribed to a directory.");r.call(this);for(let e of this.directory)t.exists(this.filter)&&!this.filter(e[1].item)||s.call(this,e[0])},b.prototype.get=function(e){if(!t.exists(this.directory))throw new Error("Cannot get whilst unsubscribed to a directory.");return this.has(e)?this.directory.get(e):void 0},b.prototype[a]=function(e,i){let o={directory:this,id:e,item:i};this.has(e)?!t.exists(this.filter)||this.filter(i)?this.dispatchEvent(t.CustomEvent("update",o)):this[p](e,i):t.exists(this.filter)&&!this.filter(i)||(s.call(this,e),this.dispatchEvent(t.CustomEvent("set",o)))},b.prototype[p]=function(e,i){if(!this.has(e))return;let o={directory:this,id:e,item:i};n.call(this,e),this.dispatchEvent(t.CustomEvent("delete",o))},b.prototype[Symbol.iterator]=function*(){if(!t.exists(this.directory))throw new Error("Cannot get key value pairs whilst unsubscribed to a directory.");for(let t of this.keys())yield[t,this.get(t)]},b.prototype.values=function*(){if(!t.exists(this.directory))throw new Error("Cannot get values whilst unsubscribed to a directory.");for(let t of this.keys())yield this.get(t)},b.prototype.query=function*(t){for(let e of this.keys()){let i=this.get(e);t(i)&&(yield i)}},t.inherit(b,Set);let m=new WeakMap,w=t.__Directory__=t.reflectConstruct(Map,"RHU.__Directory__",(function(e){t.eventTarget(this),this.options={maxOutdatedAllowed:864e5},t.parseOptions(this.options,e),this.getRecord=i.bind(this),this.subscriptions=new t.WeakCollection}));w.prototype[d]=function(t){m.has(t)&&m.get(t).subscriptions.delete(t),this.subscriptions.add(t),m.set(t,this)},w.prototype.get=function(t){return this.has(t)?i.call(this,t).item:void 0},w.prototype.set=function(o,r){if(!t.exists(o))throw Error("id cannot be undefined or null.");let s={directory:this,id:o,item:r};this.has(o)?(i.call(this,o)[l](r),this.dispatchEvent(t.CustomEvent("update",s))):(e.call(this,o,new t.DirectoryRecord(this,o,r)),this.dispatchEvent(t.CustomEvent("set",s)));for(let t of this.subscriptions)t[a](o,r)},w.prototype.delete=function(e){if(!this.has(e))return!1;let i=this.get(e),r={directory:this,id:e,item:i};o.call(this,e),this.dispatchEvent(t.CustomEvent("delete",r));for(let t of this.subscriptions)t[p](e,i);return!0},w.prototype.__fetch__=async function(){throw new Error("Not Implemented.")},w.prototype.asyncGet=async function(t,e=!1){if(!e&&this.has(t)){let e=this.getRecord(t);if(Date.now()<e.lastUpdated+this.options.maxOutdatedAllowed)return e.item}let i=await this.__fetch__(t);return this.set(t,i),i},w.prototype.query=function*(t){for(let e of this.keys()){let i=this.get(e);t(i)&&(yield i)}},t.inherit(w,Map)}))}();
