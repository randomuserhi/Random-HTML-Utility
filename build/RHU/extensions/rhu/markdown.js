!function(){"use strict";let t=window.RHU;if(null==t)throw new Error("No RHU found. Did you import RHU before running?");t.module({module:"x-rhu/markdown",trace:new Error,hard:[],soft:["Worker"]},(function(){t.exists(t.Markdown)&&console.warn("Overwriting RHU.Markdown...");let e=t.Markdown={},i=e.re={};e.re.aux={};i.blank=/\n|\r|^$/,i.newLine=/\r\n|\n|\r/,i.tab=/\t/g;let s=function(t){return t[t.length-1]},n=function(t=0,e=0,i=0,s=0){this.i=t,this.ln=e,this.idx=i,this.col=s};n.copy=function(t){return new n(t.i,t.ln,t.idx,t.col)},n.prototype.copy=function(t){Object.assign(this,t)};let o=function(t,e=undefined){this.start=t,this.end=e},r={tabSize:4},h=function(e,s=r){this.options=r,t.parseOptions(this.options,s),this.text=e,this.text.replace(i.newLine,"\n"),this.lines=e.split("\n"),this.head=this.start};h.colLength=function(t){return t.length+t.match(i.tab).length*(this.options.tabSize-1)},h.prototype[Symbol.iterator]=function*(){for(let t=this.start;t.ln<this.lines.length;t.i+=this.lines[t.ln++].length+1)this.head.copy(t),yield this.lines[t.ln]},t.definePublicAccessors(h.prototype,{start:{get:function(){return new n}},end:{get:function(){let t=s(lines);return new n(text.length,this.lines.length-1,t.length,h.colLength(t))}},first:{get:function(){return this.start()}},last:{get:function(){let t=s(lines);return new n(text.length-1,this.lines.length-1,t.length-1,h.colLength(t.slice(0,t.length-1)))}},line:{get:function(){return this.lines[this.head.ln]}}}),h.prototype.peek=function(e=1){let i="";for(let s=0;s<e;++s){let e=this.text[this.head.i];if(!t.exists(e))break;i+=e}return i},h.prototype.read=function(e=1){let s="";for(let n=0;n<e;++n){let e=this.text[this.head.i];if(!t.exists(e))break;s+=e,++this.head.i,i.newLine.test(e)?(++this.head.ln,this.head.col=0,this.head.idx=0):i.tab.test(e)?(++this.head.idx,this.head.col+=this.options.tabSize-this.head.col%this.options.tabSize):(++this.head.idx,++this.head.col)}return s},h.prototype.readToEndLine=function(){let t=this.head.idx,e=this.lines[this.head.ln];return this.head.i+=e.length-t+1,++this.head.ln,this.head.col=0,this.head.idx=0,e.slice(t)},h.prototype.nextNonSpace=function(){let e;for(;t.exists(e=this.peek())&&" "===e;)this.read()},h.prototype.match=function(t){let e=t.exec(this.text.slice(this.head.i));return null===e?null:(this.read(e.index+e[0].length),e[0])};let c=function(t,e=undefined){this.name=t,this.sourceRef=e,this.children=[]};t.definePublicAccessors(c.prototype,{first:{get:function(){return this.children[0]}},last:{get:function(){return s(this.children)}}}),c.prototype.push=function(...t){return this.children.push(...t)},c.prototype.is=function(t){return Object.prototype.isPrototypeOf.call(t.prototype,this)};let l=Symbol("Document Block"),a=function(){c.call(this,l),this.sourceRef=new o(new n)};a.prototype.close=function(){let t,e,i,s;this.sourceRef.end=new n(t,e,i,s)},a.prototype.continue=function(){return g.MATCH},a.prototype.acceptsLines=!1,a.prototype.acceptsBlocks=!0,a.prototype.allowLazyContinuation=!1,a.prototype.allowInlineParsing=!1,t.inherit(a,c);let d=e.Schema=function(){this.blocks=Map(),this.inlines=Map()};d.Block=function(){},d.Inline=function(){};let p=function(t="Node",e=undefined){c.call(this,t,e)};t.inherit(p,c),t.definePublicAccessor(e,"Node",{get:function(){return p}});let u=Symbol("Text Node"),f=function(){p.call(this,u),this.text=""};f.prototype.addText=function(t){this.text+=t},t.inherit(f,p);let k=e.InlineParser=function(e,i=undefined){this.schema=e,this.options={},Object.assign(this.options,r),t.parseOptions(this.options,i),this.TextNode=f,t.exists(this.schema[u])&&(this.TextNode=this.schema[u])};k.prototype.addNode=function(t){s(this.stack).push(t),this.stack.push(t)},k.prototype.parse=function(e,i=undefined){let n;this.doc=t.exists(i)?i:new a,this.reader=new h(e,this.options),this.stack=[this.doc];let o="";for(;""!==(n=this.reader.peek());){let t=!0,e=s(this.stack);for(let i of this.schema.matches)if(i.call(this)){if(""!==o){let t=new this.TextNode;t.addText(o),o="",e.push(t)}e=s(this.stack),t=!1}t&&(o+=this.reader.read())}if(""!==o){let t=new this.TextNode;t.addText(o),o=null,s(this.stack).push(t)}return this.doc};{let t=new k({matches:[function(){return"*"===this.reader.peek()&&(this.reader.read(),!0)}]});console.log(t.parse("***bold** italics* ```code```"))}let g=function(t="Block",e=undefined){c.call(this,t,e),this.raw="",this.acceptsLines=!0,this.acceptsBlocks=!0,this.allowLazyContinuation=!0,this.allowInlineParsing=!0};g.prototype.close=function(){if(t.exists(this.sourceRef)){let t,e,i,s;this.sourceRef.end=new n(t,e,i,s)}t.exists(this.finalize)&&this.finalize()},g.prototype.addText=function(t){this.raw+=t},t.inherit(g,c),t.definePublicAccessor(e,"Block",{get:function(){return g}});let w=Symbol("Paragraph Block"),x=function(){g.call(this,w)};x.prototype.continue=function(t){return i.blank.test(t.peek())?g.NO_MATCH:g.MATCH},t.inherit(x,g),g.START=0,g.END=3,g.MATCH=1,g.NO_MATCH=2;let y=e.BlockParser=function(e,i=undefined){let s=e.blocks.filter((t=>(t===w&&console.warn("Paragraph block cannot be part of the Types list for schema."),t!==w)));this.schema=[];for(let t=0;t<s.length;++t)this.schema.push({block:s[t],order:t});this.schema.sort(((t,e)=>t.precedence-e.precedence)),this.options={},Object.assign(this.options,r),t.parseOptions(this.options,i),this.ParagraphBlock=x,t.exists(this.schema[w])&&(this.ParagraphBlock=this.schema[w])};y.prototype.addBlock=function(t){s(this.stack).push(t),this.stack.push(t)},y.prototype.parseLine=function(e){-1!==e.indexOf("\0")&&(e=e.replace(/\0/g,"ï¿½")),this.reader.nextNonSpace();let n=0;for(;n<this.stack.length;++n){let t=!1;switch(this.stack[n].continue(this.reader)){case g.MATCH:break;case g.NO_MATCH:t=!0;break;case g.END:return;default:throw new Error("block.continue() returned illegal value.")}if(t)break}let o=[...this.stack];for(this.stack.splice(n);s(this.stack).acceptsBlocks;){let e=[];for(let t=0;t<this.schema.length;++t){let i=this.schema[t].block;this.schema[t].order;if(i.match.call(this)&&(e.push(i),1===this.schema.length||t+1<this.schema.length&&i.precedence!==this.schema[t+1].block.precedence)){1===e.length&&i.start.call(this);break}}if(0===e.length)break;e.length>1&&(e.sort(((e,i)=>{let s=t.exists(e.block.quality)?e.block.quality():-1,n=t.exists(i.block.quality)?i.block.quality():-1;return s===n?e.order-i.order:n-s})),e[0].start.call(this))}if(s(this.stack)!==s(o)&&!i.blank.test(this.reader.peek())&&s(o).allowLazyContinuation)this.stack=o,s(this.stack).addText(this.reader.readToEndLine());else{for(let t=n;t<o.length;++t)o[t].close();if(s(this.stack).acceptsLines)s(this.stack).addText(this.reader.readToEndLine());else{let t=this.reader.readToEndLine();i.blank.test(t)||(this.addBlock(new this.ParagraphBlock),s(this.stack).addText(t))}}},y.prototype.parse=function(e,i=undefined){this.doc=t.exists(i)?i:new a,this.reader=new h(e,this.options),this.stack=[this.doc];for(let t of this.reader)this.parseLine(t);for(;0!==this.stack.length;)this.stack.pop().close();return this.doc};{console.log("Testing block parser");let i=function(t=undefined){e.Block.call(this,"header",t),this.acceptsBlocks=!1,this.acceptsLines=!0,this.allowLazyContinuation=!1};i.precedence=void 0,i.quality=function(){},i.match=function(){return"#"===this.reader.peek()},i.start=function(){this.reader.read(),this.reader.nextNonSpace();let t=new i;this.addBlock(t)},i.prototype.continue=function(t){return g.NO_MATCH},t.inherit(i,e.Block);let s=new y({blocks:[i]}).parse("# well\n***this** is* a test:\n\nnice!\n\n\ncrazy");console.log(s),console.log(s.first.is(i)),console.log(s.last.is(x))}(e.Parser=function(e){t.exists(e)&&(this.blockParser=new y(e),this.inlineParser=new inlineParser(e))}).prototype.parse=function(e){if(!t.exists(this.blockParser)||!t.exists(this.inlineParser))throw new Error("Parser does not have a block or inline parser.");let i=new a,s=new h(e),n={doc:i,reader:s};return i.sourceRef.end=s.end,this.blockParser.parse(e,n),this.inlineParser.parse(e,n),i}}))}();
